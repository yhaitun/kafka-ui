<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kafka Web UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-bg: #f8f9fa;
            --dark-bg: #2c3e50;
            --border-color: #dee2e6;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .container { 
            max-width: 1400px; 
            padding: 0 20px;
        }
        
        /* 导航栏样式 */
        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 0.5rem 1rem;
        }
        
        .navbar-brand {
            font-weight: bold;
            color: white !important;
            font-size: 1.5rem;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.8) !important;
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.2s;
        }
        
        .nav-link:hover {
            color: white !important;
            background-color: rgba(255,255,255,0.1);
        }
        
        /* 统计卡片样式 */
        .stats-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        
        .stat-item {
            padding: 1.25rem;
            text-align: center;
            border-right: 1px solid #f0f0f0;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stat-icon {
            font-size: 2rem;
            color: var(--secondary-color);
            margin-right: 1rem;
        }
        
        .stat-value {
            font-size: 1.75rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        /* 卡片样式 */
        .card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.25rem;
            border-bottom: none;
        }
        
        .card-body {
            padding: 1.25rem;
        }
        
        /* 主题列表样式 */
        .topic-list-container {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }
        
        .topic-name {
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
            font-family: 'Consolas', monospace;
            font-weight: 500;
        }
        
        .list-group-item {
            border-left: none;
            border-right: none;
            padding: 0.75rem 1rem;
            transition: background-color 0.2s;
        }
        
        .list-group-item:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        /* 按钮样式 */
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .btn-outline-primary {
            color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--secondary-color);
            color: white;
        }
        .meta-column {
            flex: 0 0 15%;
            max-width: 15%;
            padding-right: 10px;
        }
        .key-column {
            flex: 0 0 25%;
            max-width: 25%;
            padding-right: 10px;
        }
        .value-column {
            flex: 0 0 60%;
            max-width: 60%;
        }
        .message-meta {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            font-size: 0.8rem;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .meta-item {
            margin-bottom: 6px;
        }
        .meta-label {
            font-weight: bold;
            color: #495057;
            font-size: 0.75rem;
            display: block;
        }
        .meta-value {
            color: #6c757d;
            font-size: 0.8rem;
            word-break: break-all;
            display: block;
        }
        .message-table {
            table-layout: fixed;
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0;
        }
        .message-table th {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            font-weight: bold;
            font-size: 0.85rem;
            text-align: left;
        }
        .message-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            vertical-align: top;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .partition-cell, .offset-cell {
            background-color: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .key-cell {
            background-color: #e3f2fd;
            border-left: 3px solid #007bff;
        }
        .value-cell {
            background-color: #e8f5e9;
            border-left: 3px solid #28a745;
        }
        .action-cell {
            text-align: center;
            vertical-align: middle;
            white-space: normal;
            padding: 8px;
        }
        .action-cell .btn {
            white-space: nowrap;
            min-width: 80px;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-database me-2"></i>Kafka Web UI
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/"><i class="fas fa-home me-1"></i>首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/clusters}"><i class="fas fa-server me-1"></i>集群管理</a>
                    </li>
                </ul>
                <!-- 集群选择 -->
                <div th:if="${clusters != null and !clusters.empty}" class="dropdown">
                    <button class="btn btn-light dropdown-toggle" type="button" id="clusterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-server me-1"></i>
                        <span th:if="${activeCluster != null}" th:text="${activeCluster.name}"></span>
                        <span th:if="${activeCluster == null}">选择集群</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="clusterDropdown">
                        <li><a class="dropdown-item" th:href="@{/}">默认集群</a></li>
                        <li th:each="cluster : ${clusters}">
                            <a class="dropdown-item" th:href="@{'/cluster/' + ${cluster.id}}" th:text="${cluster.name}"></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="container">
        
        <!-- 消息提示 -->
        <div th:if="${message}" class="alert alert-info" role="alert">
            <span th:text="${message}"></span>
        </div>
        
        <!-- 当前集群信息 -->
        <div th:if="${activeCluster != null}" class="alert alert-primary d-flex justify-content-between align-items-center">
            <div>
                <strong>当前集群:</strong> 
                <span th:text="${activeCluster.name}"></span> 
                <span th:text="'(' + ${activeCluster.bootstrapServers} + ')'"></span>
            </div>
            <span class="cluster-badge badge bg-info">激活</span>
        </div>
        
        <div class="row">
            <!-- 左侧：主题管理 -->
            <div class="col-md-4">
                <div class="card section">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>主题管理</h5>
                    </div>
                    <div class="card-body">
                        <!-- 创建主题表单放在顶部 -->
                        <h6>创建新主题</h6>
                        <form th:action="@{/topic/create}" method="post" class="mb-3">
                            <div class="mb-2">
                                <input type="text" name="topicName" class="form-control" placeholder="主题名称" required>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label class="form-label small">分区数</label>
                                    <input type="number" name="partitions" class="form-control" value="1" min="1" placeholder="1">
<!--                                    <small class="form-text text-muted">决定并行处理能力，建议1-3个</small>-->
                                </div>
                                <div class="col">
                                    <label class="form-label small">副本因子</label>
                                    <input type="number" name="replicationFactor" class="form-control" value="1" min="1" placeholder="1">
<!--                                    <small class="form-text text-muted">决定数据冗余，建议1-3个</small>-->
                                </div>
                            </div>
                            <!-- 集群ID隐藏字段 -->
                            <input th:if="${activeCluster != null}" type="hidden" name="clusterId" th:value="${activeCluster.id}">
                            <button type="submit" class="btn btn-success btn-sm w-100">创建主题</button>
                        </form>
                        
                        <!-- 主题统计卡片 -->
                        <div class="stats-card mb-3">
                            <div class="row g-0">
                                <div class="col-md-4">
                                    <div class="stat-item">
                                        <div class="stat-icon"><i class="fas fa-exchange-alt"></i></div>
                                        <div class="stat-content">
                                            <div class="stat-value" th:text="${topics != null ? topics.size() : 0}">0</div>
                                            <div class="stat-label">主题总数</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stat-item">
                                        <div class="stat-icon"><i class="fas fa-server"></i></div>
                                        <div class="stat-content">
                                            <div class="stat-value" th:text="${activeCluster != null ? 1 : 0}">0</div>
                                            <div class="stat-label">活跃集群</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stat-item">
                                        <div class="stat-icon"><i class="fas fa-clock"></i></div>
                                        <div class="stat-content">
                                            <div class="stat-value" id="uptime">0</div>
                                            <div class="stat-label">运行时间(分钟)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 主题列表 -->
                        <h6><i class="fas fa-list me-2"></i>现有主题</h6>
                        <div class="mb-2">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" id="topicSearch" class="form-control" placeholder="搜索主题..." onkeyup="filterTopics()" onkeypress="handleTopicSearchEnter(event)">
                                <button class="btn btn-outline-primary" type="button" onclick="searchTopic()">
                                    搜索
                                </button>
                            </div>
                        </div>
                        <div class="topic-list-container">
                            <ul class="list-group" id="topicList">
                                <li th:each="topic : ${topics}" class="list-group-item d-flex justify-content-between align-items-center topic-item">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-exchange-alt me-2 text-primary"></i>
                                        <span class="topic-name" th:text="${topic}" th:title="${topic}"></span>
                                    </div>
                                    <div class="topic-actions">
                                <a th:if="${activeCluster != null}" th:href="@{/message/consume(topic=${topic}, clusterId=${activeCluster.id})}" class="btn btn-sm btn-outline-primary" style="width: 110px;"><i class="fas fa-eye me-1"></i>查看消息</a>
                                <a th:if="${activeCluster == null}" th:href="@{/message/consume(topic=${topic})}" class="btn btn-sm btn-outline-primary" style="width: 110px;"><i class="fas fa-eye me-1"></i>查看消息</a>
                            </div>
                                </li>
                            </ul>
                            <!-- 无搜索结果提示 -->
                            <div id="noSearchResults" class="alert alert-info mt-2" style="display: none;">
                                <i class="fas fa-info-circle me-2"></i>没有找到匹配的主题
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：消息操作 -->
            <div class="col-md-8">
                <!-- 发送消息 -->
                <div class="card section">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-paper-plane me-2"></i>发送消息</h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/message/send}" method="post">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label small">选择主题</label>
                                    <select name="topic" class="form-select" required>
                                        <option value="">选择主题</option>
                                        <option th:each="topic : ${topics}" th:value="${topic}" th:text="${topic}"></option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">消息键</label>
                                    <input type="text" name="key" class="form-control" placeholder="可选">
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label small">消息内容</label>
                                    <input type="text" name="message" class="form-control" placeholder="输入消息内容" required>
                                </div>
                            </div>
                            <!-- 集群ID隐藏字段 -->
                            <input th:if="${activeCluster != null}" type="hidden" name="clusterId" th:value="${activeCluster.id}">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane me-1"></i>发送消息</button>
                        </form>
                    </div>
                </div>
                
                <!-- 消费消息 -->
                <div class="card section">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>消息消费</h5>
                        <div>
                            <span th:if="${selectedTopic}" class="badge bg-secondary me-2" th:text="'主题: ' + ${selectedTopic}"></span>
                            <span th:if="${activeCluster != null}" class="cluster-badge badge bg-info" th:text="'集群: ' + ${activeCluster.name}"></span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div th:if="${messages != null and !messages.empty}">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">最新消息</h6>
                                <div class="d-flex align-items-center">
                                    <span class="me-2">分区:</span>
                                    <select id="partitionSelector" class="form-select form-select-sm me-3" style="width: auto;" onchange="reloadWithPartition(this.value)">
                                        <option value="-1">所有分区</option>
                                        <option th:each="partition : ${#numbers.sequence(0, 9)}" th:value="${partition}" th:text="${partition}"></option>
                                    </select>
                                    <span class="message-count" th:text="${messages.size()} + ' 条消息'"></span>
                                </div>
                            </div>
                            
                            <!-- 统一的消息表格 -->
                            <table class="table table-bordered message-table">
                                <thead>
                                    <tr>
                                        <th width="8%">分区</th>
                                        <th width="8%">偏移</th>
                                        <th width="10%">Key</th>
                                        <th width="54%">Value</th>
                                        <th width="20%">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="message, iter : ${messages}" class="message-row" th:attr="data-partition=${message.contains('Partition: ') ? message.substring(message.indexOf('Partition: ') + 11, message.indexOf(', Offset:')).trim() : '-1'}">
                                        <td class="partition-cell">
                                            <span th:text="${message.contains('Partition: ') ? message.substring(message.indexOf('Partition: ') + 11, message.indexOf(', Offset:')).trim() : 'N/A'}"></span>
                                        </td>
                                        <td class="offset-cell">
                                            <span th:text="${message.contains('Offset: ') ? message.substring(message.indexOf(', Offset: ') + 10).trim() : 'N/A'}"></span>
                                        </td>
                                        <td class="key-cell">
                                            <div th:switch="${message.contains('Key: ')}">
                                                <div th:case="true" th:text="${message.startsWith('Key: null') ? 'null' : message.substring(message.indexOf('Key: ') + 5, message.indexOf(', Value:')).trim()}" th:style="${message.startsWith('Key: null') ? 'color: #6c757d; font-style: italic;' : ''}"></div>
                                                <div th:case="*" th:text="${message}"></div>
                                            </div>
                                        </td>
                                        <td class="value-cell">
                                            <div th:switch="${message.contains('Value: ')}">
                                                <div th:case="true" th:text="${message.substring(message.indexOf('Value: ') + 7, message.indexOf(', Partition:')).trim()}" th:style="${message.substring(message.indexOf('Value: ') + 7, message.indexOf(', Partition:')).trim() == 'null' ? 'color: #6c757d; font-style: italic;' : 'white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 400px;'}" th:title="${message.substring(message.indexOf('Value: ') + 7, message.indexOf(', Partition:')).trim()}"></div>
                                                <div th:case="*" th:text="${message}" th:style="'white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 400px;'" th:title="${message}"></div>
                                            </div>
                                        </td>
                                        <td class="action-cell" style="text-align: center; padding: 4px;">
                                            <button class="btn btn-sm btn-outline-primary" type="button"
                                                    th:attr="data-message=${message}"
                                                    onclick="showMessageDetail(this.dataset.message)"
                                                    style="min-width: 90px; padding: 0.2rem 0.4rem; font-size: 0.8rem; white-space: nowrap;">
                                                查看详情
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div th:if="${messages != null and messages.empty}" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                <p class="mb-0">该主题暂无消息</p>
                            </div>
                        </div>
                        <div th:if="${messages == null}" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                <p class="mb-0">请选择一个主题查看消息</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 消息详情模态框 -->
    <div class="modal fade" id="messageDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">消息详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <pre id="modalMessageContent" style="white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace;"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 计算运行时间
        document.addEventListener('DOMContentLoaded', function() {
            const startTime = new Date();
            
            // 更新运行时间
            function updateUptime() {
                const currentTime = new Date();
                const uptimeMinutes = Math.floor((currentTime - startTime) / 60000);
                document.getElementById('uptime').textContent = uptimeMinutes;
                setTimeout(updateUptime, 60000); // 每分钟更新一次
            }
            
            updateUptime();
        });
        
        function showMessageDetail(message) {
            console.log("message:", message); // 调试用

            // 从完整消息中提取Value内容
            let valueContent = message;
            
            // 如果消息包含Value字段，提取Value部分
            if (message.includes('Value: ')) {
                try {
                    // 提取Value: 后面的内容，直到下一个逗号或字符串结束
                    const valueStart = message.indexOf('Value: ') + 7;
                    let valueEnd = message.indexOf(', Partition:');
                    if (valueEnd === -1) {
                        valueEnd = message.length;
                    }
                    valueContent = message.substring(valueStart, valueEnd).trim();
                    
                    // 如果Value是null，显示为null
                    if (valueContent === 'null') {
                        valueContent = 'null';
                    }
                } catch (e) {
                    console.error("提取Value失败:", e);
                    // 如果提取失败，显示原始消息
                    valueContent = message;
                }
            }
            
            document.getElementById('modalMessageContent').textContent = valueContent;
            var modal = new bootstrap.Modal(document.getElementById('messageDetailModal'));
            modal.show();
        }

        // 主题搜索功能
        function filterTopics() {
            const searchText = document.getElementById('topicSearch').value.toLowerCase();
            const topicItems = document.querySelectorAll('.topic-item');
            let hasVisibleTopics = false;
            
            topicItems.forEach(item => {
                const topicNameElement = item.querySelector('.topic-name');
                if (!topicNameElement) return;
                
                const topicName = topicNameElement.textContent.toLowerCase();
                if (topicName.includes(searchText)) {
                    item.style.display = '';
                    hasVisibleTopics = true;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // 显示无结果提示
            const noResultsElement = document.getElementById('noSearchResults');
            if (noResultsElement) {
                noResultsElement.style.display = hasVisibleTopics ? 'none' : 'block';
            }
        }
        
        // 搜索按钮点击事件
        function searchTopic() {
            filterTopics();
        }
        
        // 回车键搜索
        function handleTopicSearchEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                filterTopics();
            }
        }

        // 分区过滤功能
        function filterMessagesByPartition() {
            const selectedPartition = document.getElementById('partitionSelector').value;
            const messageRows = document.querySelectorAll('.message-row');
            let visibleCount = 0;
            
            messageRows.forEach(row => {
                const rowPartition = row.getAttribute('data-partition');
                console.log('Row partition:', rowPartition, 'Selected partition:', selectedPartition); // 调试信息
                
                if (selectedPartition === '-1' || rowPartition === selectedPartition) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // 更新消息计数
            const messageCountElement = document.querySelector('.message-count');
            if (messageCountElement) {
                messageCountElement.textContent = visibleCount + ' 条消息';
            }
        }

        // 处理主题搜索框的回车键
        function handleTopicSearchEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const searchText = document.getElementById('topicSearch').value.trim();
                if (searchText) {
                    // 调用后端搜索接口而不是直接跳转
                    searchTopicsFromBackend(searchText);
                } else {
                    // 如果搜索框为空，执行普通过滤
                    filterTopics();
                }
            }
        }

        // 搜索并跳转到指定主题
        function searchAndNavigateToTopic(topicName) {
            const clusterId = getClusterIdFromUrl();
            
            // 构建跳转URL
            let targetUrl = '/message/consume?topic=' + encodeURIComponent(topicName);
            if (clusterId) {
                targetUrl += '&clusterId=' + clusterId;
            }
            
            window.location.href = targetUrl;
        }

        // 搜索按钮点击事件
        function searchTopic() {
            const searchText = document.getElementById('topicSearch').value.trim();
            if (searchText) {
                // 调用后端搜索接口
                searchTopicsFromBackend(searchText);
            } else {
                // 如果搜索框为空，执行普通过滤
                filterTopics();
            }
        }
        
        // 从URL中提取clusterId的辅助函数
    function getClusterIdFromUrl() {
        // 1. 优先从localStorage获取
        const localStorageClusterId = localStorage.getItem('kafkaUiClusterId');
        if (localStorageClusterId) {
            return localStorageClusterId;
        }
        
        // 2. 从路径中提取，格式如 /cluster/{clusterId}
        const currentPath = window.location.pathname;
        if (currentPath.startsWith('/cluster/')) {
            const pathParts = currentPath.split('/').filter(part => part.length > 0); // 过滤空字符串
            if (pathParts.length >= 2) {
                const clusterId = pathParts[1]; // 第一个元素是'cluster'，第二个是clusterId
                // 存储到localStorage
                localStorage.setItem('kafkaUiClusterId', clusterId);
                return clusterId;
            }
        }
        
        // 3. 从查询参数中提取
        const urlParams = new URLSearchParams(window.location.search);
        const paramClusterId = urlParams.get('clusterId');
        if (paramClusterId) {
            // 存储到localStorage
            localStorage.setItem('kafkaUiClusterId', paramClusterId);
            return paramClusterId;
        }
        
        return null;
    }
    
    // 保存clusterId到localStorage的函数
    function saveClusterIdToLocalStorage(clusterId) {
        if (clusterId) {
            localStorage.setItem('kafkaUiClusterId', clusterId);
        }
    }
        
        // 确保在页面加载时就设置正确的clusterId
        document.addEventListener('DOMContentLoaded', function() {
            // 检查当前URL是否包含clusterId参数
            const urlParams = new URLSearchParams(window.location.search);
            const hasClusterIdParam = urlParams.has('clusterId');
            
            // 检查当前路径是否包含cluster信息
            const currentPath = window.location.pathname;
            const hasClusterInPath = currentPath.startsWith('/cluster/');
            
            // 如果URL中既没有clusterId参数，也没有包含cluster的路径，且当前不在根路径
            if (!hasClusterIdParam && !hasClusterInPath && currentPath !== '/') {
                // 1. 优先检查localStorage
                const localStorageClusterId = localStorage.getItem('kafkaUiClusterId');
                if (localStorageClusterId) {
                    // 重定向到带有clusterId参数的URL
                    window.location.href = currentPath + '?clusterId=' + localStorageClusterId;
                    return;
                }
                
                // 2. 尝试从集群选择下拉菜单获取活动集群ID
                const activeClusterElement = document.querySelector('#clusterDropdown .dropdown-toggle span');
                if (activeClusterElement && activeClusterElement.textContent && activeClusterElement.textContent !== '选择集群') {
                    // 尝试从下拉菜单中找到对应的集群链接
                    const clusterLinks = document.querySelectorAll('.dropdown-menu .dropdown-item');
                    for (let link of clusterLinks) {
                        if (link.textContent.trim() !== '默认集群' && link.href.includes('/cluster/')) {
                            const clusterId = link.href.split('/cluster/')[1];
                            if (clusterId) {
                                // 保存到localStorage
                                saveClusterIdToLocalStorage(clusterId);
                                // 重定向到包含clusterId的URL
                                window.location.href = currentPath + '?clusterId=' + clusterId;
                                return;
                            }
                        }
                    }
                }
            }
        });
        
        // 从后端搜索主题
        function searchTopicsFromBackend(keyword) {
            // 获取clusterId
            let clusterId = getClusterIdFromUrl();
            
            // 如果从URL中没有获取到clusterId，尝试从下拉菜单中获取当前活动集群
            if (!clusterId) {
                const activeClusterElement = document.querySelector('#clusterDropdown .dropdown-toggle span');
                if (activeClusterElement && activeClusterElement.textContent && activeClusterElement.textContent !== '选择集群') {
                    // 尝试从下拉菜单中找到对应的集群链接
                    const clusterLinks = document.querySelectorAll('.dropdown-menu .dropdown-item');
                    for (let link of clusterLinks) {
                        if (link.textContent.trim() !== '默认集群' && link.href.includes('/cluster/')) {
                            const potentialClusterId = link.href.split('/cluster/')[1];
                            if (potentialClusterId) {
                                clusterId = potentialClusterId;
                                // 保存到localStorage
                                saveClusterIdToLocalStorage(clusterId);
                                break;
                            }
                        }
                    }
                }
            }
            
            // 如果仍然没有获取到clusterId，尝试从页面上的其他元素获取
            if (!clusterId) {
                const clusterIdElement = document.querySelector('[data-cluster-id]');
                if (clusterIdElement) {
                    clusterId = clusterIdElement.getAttribute('data-cluster-id');
                }
            }
            
            // 如果仍然没有获取到clusterId，使用默认值
            if (!clusterId) {
                clusterId = 'default';
                // 保存默认值到localStorage以便后续使用
                saveClusterIdToLocalStorage(clusterId);
            }
            
            // 构建搜索URL
            let searchUrl = '/topic/search?keyword=' + encodeURIComponent(keyword);
            // 添加clusterId参数
            searchUrl += '&clusterId=' + clusterId;
            
            // 重定向到搜索URL
            window.location.href = searchUrl;
        }
        
        // 更新主题列表
        function updateTopicList(topics) {
            const topicListContainer = document.getElementById('topicList');
            
            const clusterId = getClusterIdFromUrl();
            
            console.log('updateTopicList - clusterId参数:', clusterId);
            
            // 清空当前主题列表
            topicListContainer.innerHTML = '';
            
            // 重新渲染主题列表
            topics.forEach(topic => {
                const topicItem = document.createElement('div');
                topicItem.className = 'topic-item d-flex align-items-center p-2 border-bottom';
                
                // 构建查看消息的链接，包含clusterId参数
                let messageUrl = '/message/consume?topic=' + encodeURIComponent(topic);
                if (clusterId) {
                    messageUrl += '&clusterId=' + clusterId;
                }
                
                console.log('生成的消息链接:', messageUrl);
                
                topicItem.innerHTML = `
                    <div class="topic-name flex-grow-1" style="font-size: 0.9rem;">${topic}</div>
                    <div class="topic-actions">
                        <a href="${messageUrl}" class="btn btn-sm btn-outline-primary">查看消息</a>
                    </div>
                `;
                topicListContainer.appendChild(topicItem);
            });
            
            // 如果没有匹配的主题，显示提示信息
            if (topics.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'text-center py-4 text-muted';
                noResults.innerHTML = '<i class="fas fa-search"></i><br>没有找到匹配的主题';
                topicListContainer.appendChild(noResults);
            }
        }

        // 根据选择的分区重新加载页面
        function reloadWithPartition(partition) {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('partition', partition);
            
            // 保留其他参数
            const topic = urlParams.get('topic');
            
            const clusterId = getClusterIdFromUrl();
            
            // 如果有clusterId，添加到URL参数中
            if (clusterId) {
                urlParams.set('clusterId', clusterId);
            }
            
            // 构建新的URL
            let newUrl = '/message/consume?' + urlParams.toString();
            
            // 如果当前页面没有topic参数，则重定向到首页
            if (!topic) {
                newUrl = '/';
            }
            
            window.location.href = newUrl;
        }
    </script>
</body>
</html>