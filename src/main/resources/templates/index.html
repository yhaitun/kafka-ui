<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kafka Web UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 1200px; }
        .section { margin-bottom: 2rem; }
        .message-item { 
            background: #f8f9fa; 
            border-left: 4px solid #007bff;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .cluster-badge {
            font-size: 0.8rem;
        }
        .topic-name {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
        }
        .topic-list-container {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
        .message-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: #6c757d;
        }
        .message-content {
            background: #f8f9fa;
            border-radius: 4px;
            word-break: break-word;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .message-key, .message-value {
            padding: 10px;
            border-left: 3px solid #28a745;
        }
        .message-key {
            border-left-color: #007bff;
            background: #e3f2fd;
        }
        .message-value {
            border-left-color: #28a745;
            background: #e8f5e9;
        }
        .message-meta {
            padding: 8px 10px;
            background: #f1f3f4;
            border-top: 1px solid #e9ecef;
            border-radius: 0 0 4px 4px;
            font-size: 0.8rem;
            color: #6c757d;
        }
        .message-label {
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
            font-size: 0.85rem;
        }
        .message-count {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        .meta-column {
            flex: 0 0 15%;
            max-width: 15%;
            padding-right: 10px;
        }
        .key-column {
            flex: 0 0 25%;
            max-width: 25%;
            padding-right: 10px;
        }
        .value-column {
            flex: 0 0 60%;
            max-width: 60%;
        }
        .message-meta {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            font-size: 0.8rem;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .meta-item {
            margin-bottom: 6px;
        }
        .meta-label {
            font-weight: bold;
            color: #495057;
            font-size: 0.75rem;
            display: block;
        }
        .meta-value {
            color: #6c757d;
            font-size: 0.8rem;
            word-break: break-all;
            display: block;
        }
        .message-table {
            table-layout: fixed;
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0;
        }
        .message-table th {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            font-weight: bold;
            font-size: 0.85rem;
            text-align: left;
        }
        .message-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            vertical-align: top;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .partition-cell, .offset-cell {
            background-color: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .key-cell {
            background-color: #e3f2fd;
            border-left: 3px solid #007bff;
        }
        .value-cell {
            background-color: #e8f5e9;
            border-left: 3px solid #28a745;
        }
        .action-cell {
            text-align: center;
            vertical-align: middle;
            white-space: normal;
            padding: 8px;
        }
        .action-cell .btn {
            white-space: nowrap;
            min-width: 80px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Kafka Web UI</h1>
            <div class="d-flex align-items-center gap-2">
                <!-- 集群管理按钮 -->
                <a th:href="@{/clusters}" class="btn btn-outline-secondary">集群管理</a>
                <!-- 集群选择 -->
                <div th:if="${clusters != null and !clusters.empty}" class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" id="clusterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <span th:if="${activeCluster != null}" th:text="'集群: ' + ${activeCluster.name}"></span>
                        <span th:if="${activeCluster == null}">选择集群</span>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="clusterDropdown">
                        <li><a class="dropdown-item" th:href="@{/}">默认集群</a></li>
                        <li th:each="cluster : ${clusters}">
                            <a class="dropdown-item" th:href="@{'/cluster/' + ${cluster.id}}" th:text="${cluster.name}"></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- 消息提示 -->
        <div th:if="${message}" class="alert alert-info" role="alert">
            <span th:text="${message}"></span>
        </div>
        
        <!-- 当前集群信息 -->
        <div th:if="${activeCluster != null}" class="alert alert-primary d-flex justify-content-between align-items-center">
            <div>
                <strong>当前集群:</strong> 
                <span th:text="${activeCluster.name}"></span> 
                <span th:text="'(' + ${activeCluster.bootstrapServers} + ')'"></span>
            </div>
            <span class="cluster-badge badge bg-info">激活</span>
        </div>
        
        <div class="row">
            <!-- 左侧：主题管理 -->
            <div class="col-md-4">
                <div class="card section">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>主题管理</h5>
                    </div>
                    <div class="card-body">
                        <!-- 创建主题表单放在顶部 -->
                        <h6>创建新主题</h6>
                        <form th:action="@{/topic/create}" method="post" class="mb-3">
                            <div class="mb-2">
                                <input type="text" name="topicName" class="form-control" placeholder="主题名称" required>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label class="form-label small">分区数</label>
                                    <input type="number" name="partitions" class="form-control" value="1" min="1" placeholder="1">
<!--                                    <small class="form-text text-muted">决定并行处理能力，建议1-3个</small>-->
                                </div>
                                <div class="col">
                                    <label class="form-label small">副本因子</label>
                                    <input type="number" name="replicationFactor" class="form-control" value="1" min="1" placeholder="1">
<!--                                    <small class="form-text text-muted">决定数据冗余，建议1-3个</small>-->
                                </div>
                            </div>
                            <!-- 集群ID隐藏字段 -->
                            <input th:if="${activeCluster != null}" type="hidden" name="clusterId" th:value="${activeCluster.id}">
                            <button type="submit" class="btn btn-success btn-sm w-100">创建主题</button>
                        </form>
                        
                        <!-- 主题列表 -->
                        <h6>现有主题</h6>
                        <div class="topic-list-container">
                            <ul class="list-group">
                                <li th:each="topic : ${topics}" class="list-group-item d-flex justify-content-between align-items-center">
                                    <span class="topic-name" th:text="${topic}" title="${topic}"></span>
                                    <a th:if="${activeCluster != null}" th:href="@{/message/consume(topic=${topic}, clusterId=${activeCluster.id})}" class="btn btn-sm btn-outline-primary">查看消息</a>
                                    <a th:if="${activeCluster == null}" th:href="@{/message/consume(topic=${topic})}" class="btn btn-sm btn-outline-primary">查看消息</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：消息操作 -->
            <div class="col-md-8">
                <!-- 发送消息 -->
                <div class="card section">
                    <div class="card-header">
                        <h5>发送消息</h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/message/send}" method="post">
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <select name="topic" class="form-control" required>
                                        <option value="">选择主题</option>
                                        <option th:each="topic : ${topics}" th:value="${topic}" th:text="${topic}"></option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="text" name="key" class="form-control" placeholder="消息键（可选）">
                                </div>
                                <div class="col-md-5">
                                    <input type="text" name="message" class="form-control" placeholder="消息内容" required>
                                </div>
                            </div>
                            <!-- 集群ID隐藏字段 -->
                            <input th:if="${activeCluster != null}" type="hidden" name="clusterId" th:value="${activeCluster.id}">
                            <button type="submit" class="btn btn-primary">发送消息</button>
                        </form>
                    </div>
                </div>
                
                <!-- 消费消息 -->
                <div class="card section">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>消息消费</h5>
                        <div>
                            <span th:if="${selectedTopic}" class="badge bg-secondary me-2" th:text="'主题: ' + ${selectedTopic}"></span>
                            <span th:if="${activeCluster != null}" class="cluster-badge badge bg-info" th:text="'集群: ' + ${activeCluster.name}"></span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div th:if="${messages != null and !messages.empty}">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">最新消息</h6>
                                <span class="message-count" th:text="${messages.size()} + ' 条消息'"></span>
                            </div>
                            
                            <!-- 统一的消息表格 -->
                            <table class="table table-bordered message-table">
                                <thead>
                                    <tr>
                                        <th width="10%">分区</th>
                                        <th width="10%">偏移</th>
                                        <th width="15%">Key</th>
                                        <th width="55%">Value</th>
                                        <th width="10%">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="message, iter : ${messages}" class="message-row">
                                        <td class="partition-cell">
                                            <span th:text="${message.contains('Partition: ') ? message.substring(message.indexOf('Partition: ') + 11, message.indexOf(', Offset:')).trim() : 'N/A'}"></span>
                                        </td>
                                        <td class="offset-cell">
                                            <span th:text="${message.contains('Offset: ') ? message.substring(message.indexOf(', Offset: ') + 10).trim() : 'N/A'}"></span>
                                        </td>
                                        <td class="key-cell">
                                            <div th:switch="${message.contains('Key: ')}">
                                                <div th:case="true" th:text="${message.startsWith('Key: null') ? 'null' : message.substring(message.indexOf('Key: ') + 5, message.indexOf(', Value:')).trim()}" th:style="${message.startsWith('Key: null') ? 'color: #6c757d; font-style: italic;' : ''}"></div>
                                                <div th:case="*" th:text="${message}"></div>
                                            </div>
                                        </td>
                                        <td class="value-cell">
                                            <div th:switch="${message.contains('Value: ')}">
                                                <div th:case="true" th:text="${message.substring(message.indexOf('Value: ') + 7, message.indexOf(', Partition:')).trim()}" th:style="${message.substring(message.indexOf('Value: ') + 7, message.indexOf(', Partition:')).trim() == 'null' ? 'color: #6c757d; font-style: italic;' : 'white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 400px;'}" th:title="${message.substring(message.indexOf('Value: ') + 7, message.indexOf(', Partition:')).trim()}"></div>
                                                <div th:case="*" th:text="${message}" th:style="'white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 400px;'" th:title="${message}"></div>
                                            </div>
                                        </td>
                                        <td class="action-cell">
                                            <button class="btn btn-sm btn-outline-primary" type="button"
                                                    th:attr="data-message=${message}"
                                                    onclick="showMessageDetail(this.dataset.message)">
                                                查看详情
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div th:if="${messages != null and messages.empty}" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                <p class="mb-0">该主题暂无消息</p>
                            </div>
                        </div>
                        <div th:if="${messages == null}" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                <p class="mb-0">请选择一个主题查看消息</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 消息详情模态框 -->
    <div class="modal fade" id="messageDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">消息详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <pre id="modalMessageContent" style="white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace;"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showMessageDetail(message) {
            console.log("message:", message); // 调试用
            document.getElementById('modalMessageContent').textContent = message;
            var modal = new bootstrap.Modal(document.getElementById('messageDetailModal'));
            modal.show();
        }
    </script>
</body>
</html>